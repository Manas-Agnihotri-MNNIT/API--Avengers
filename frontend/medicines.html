<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medicines</title>
    <link rel="stylesheet" href="dashboard.css" />
    <link rel="stylesheet" href="medicines.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  </head>

  <body>
    <div class="dashboard-layout">
      <aside class="sidebar">
        <h2 class="sidebar-logo"><i class="fa-solid fa-wand-magic-sparkles"></i></h2>
        <ul class="sidebar-menu">
          <li><a href="dashboard.html"><i class="fa-solid fa-table-columns"></i></a></li>
          <li><a href="profile.html"><i class="fa-solid fa-user"></i></a></li>
          <li><a href="medicines.html" class="active"><i class="fa-solid fa-pills"></i></a></li>
          <!-- <li><a href="schedule.html"><i class="fa-solid fa-calendar-check"></i></a></li> -->
          <li><a href="analytics.html"><i class="fa-solid fa-chart-line"></i></a></li>
          <li><a href="settings.html"><i class="fa-solid fa-gear"></i></a></li>
        </ul>
      </aside>

      <main class="dashboard-main">
        <div class="dashboard-container medicines-page">
          <header class="med-header">
            <h2 class="dashboard-title"><i class="fa-solid fa-pills"></i> Your Medicines</h2>
            <div class="med-actions">
              <input id="search" type="search" placeholder="Search medicines or dosage..." />
              <button id="toggle-form" class="btn primary"><i class="fa-solid fa-plus"></i> Add Medicine</button>
            </div>
          </header>

          <section id="add-form" class="med-form" aria-hidden="true">
            <form id="medicineForm">
              <div class="form-row">
                <label for="name">Name</label>
                <input id="name" name="name" required />
              </div>
              <div class="form-row">
                <label for="dosage">Dosage</label>
                <input id="dosage" name="dosage" placeholder="e.g., 500mg or 1 tablet" required />
              </div>
              <div class="form-row">
                <label for="time">Time</label>
                <input id="time" name="time" type="time" required />
              </div>
              <div class="form-row">
                <label for="email">Contact Email</label>
                <input id="email" name="email" type="email" placeholder="optional" />
              </div>
              <div class="form-row">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="2" placeholder="optional"></textarea>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn primary">Save</button>
                <button type="button" id="cancel" class="btn">Cancel</button>
              </div>
            </form>
          </section>

          <hr />

          <section class="med-list-section">
            <div id="medicines-list" class="medicines-list" aria-live="polite"></div>
            <div id="empty" class="empty" hidden>No medicines found. Add one using the button above.</div>
          </section>
        </div>
      </main>
    </div>

    <script>
  const userId = localStorage.getItem("userId");
  const token = localStorage.getItem("token");

      // State
      let medicines = [];

      // Elements
      const listEl = document.getElementById("medicines-list");
      const emptyEl = document.getElementById("empty");
      const searchEl = document.getElementById("search");
      const toggleBtn = document.getElementById("toggle-form");
      const addFormSection = document.getElementById("add-form");
      const medicineForm = document.getElementById("medicineForm");
      const cancelBtn = document.getElementById("cancel");

      function renderList(items) {
        if (!items || items.length === 0) {
          listEl.innerHTML = "";
          emptyEl.hidden = false;
          return;
        }

        emptyEl.hidden = true;
        listEl.innerHTML = items
          .map(
            (m) => `
            <article class="medicine-card">
              <div class="card-left">
                <h3 class="med-name">${escapeHtml(m.name)}</h3>
                <div class="med-meta">${escapeHtml(m.dosage)} â€¢ ${escapeHtml(m.time || "-")}</div>
                ${m.email ? `<div class="med-email">${escapeHtml(m.email)}</div>` : ""}
                ${m.notes ? `<p class=\"med-notes\">${escapeHtml(m.notes)}</p>` : ""}
              </div>
              <div class="card-right">
                <button class="btn small" data-id="${m._id}" data-action="taken">${m.taken ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-circle"></i>'} ${m.taken ? 'Taken' : 'Mark'}</button>
                <button class="btn small" data-id="${m._id}" data-action="missed">${!m.taken ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-circle"></i>'} ${!m.taken ? 'Missed' : 'Mark'}</button>
                <button class="btn small danger" data-id="${m._id}" data-action="delete"><i class="fa-solid fa-trash"></i></button>
              </div>
            </article>
          `
          )
          .join("");

        // Attach handlers
        document.querySelectorAll('.btn.small[data-action]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = btn.getAttribute('data-id');
            const action = btn.getAttribute('data-action');

            if (action === 'delete') {
              if (!confirm('Delete this medicine?')) return;
              await deleteMedicine(id);
              return;
            }

            if (action === 'taken' || action === 'missed') {
              const taken = action === 'taken';
              await setTakenStatus(id, taken);
              return;
            }
          });
        });
      }

      function escapeHtml(str) {
        if (!str && str !== 0) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      async function loadMedicines() {
        try {
          const res = await fetch("http://localhost:5000/api/medicines/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token }),
          });

          if (!res.ok) throw new Error("Failed to fetch medicines");

          medicines = await res.json();
          renderList(medicines);
        } catch (err) {
          console.error(err);
          listEl.innerHTML = '<div class="error">Could not load medicines. Make sure the backend is running.</div>';
        }
      }

      // Filter client-side
      searchEl.addEventListener("input", (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (!q) return renderList(medicines);
        const filtered = medicines.filter(
          (m) => (m.name && m.name.toLowerCase().includes(q)) || (m.dosage && m.dosage.toLowerCase().includes(q))
        );
        renderList(filtered);
      });

      // Toggle form
      toggleBtn.addEventListener("click", () => {
        const visible = addFormSection.getAttribute("aria-hidden") === "false";
        addFormSection.setAttribute("aria-hidden", String(!visible));
        addFormSection.style.display = visible ? "none" : "block";
      });

      cancelBtn.addEventListener("click", () => {
        addFormSection.setAttribute("aria-hidden", "true");
        addFormSection.style.display = "none";
        medicineForm.reset();
      });

      medicineForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          // token will be used by backend to identify user
          token,
          name: document.getElementById("name").value.trim(),
          dosage: document.getElementById("dosage").value.trim(),
          time: document.getElementById("time").value,
          email: document.getElementById("email").value.trim(),
          notes: document.getElementById("notes").value.trim(),
        };

        try {
          const res = await fetch("http://localhost:5000/api/medicines/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const json = await res.json();
          if (!res.ok) throw new Error(json.message || "Failed to save");

          // Refresh list
          medicineForm.reset();
          addFormSection.setAttribute("aria-hidden", "true");
          addFormSection.style.display = "none";
          await loadMedicines();
        } catch (err) {
          console.error(err);
          alert(err.message || "Could not add medicine. Check server logs.");
        }
      });

      // initial
      document.addEventListener("DOMContentLoaded", () => {
        // hide form initially
        addFormSection.style.display = "none";
        loadMedicines();
      });

      async function setTakenStatus(id, taken) {
        try {
          const res = await fetch(`http://localhost:5000/api/medicines/${id}/taken`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, taken }),
          });

          const json = await res.json();
          if (!res.ok) throw new Error(json.message || 'Could not update');
          await loadMedicines();
        } catch (err) {
          console.error(err);
          alert(err.message || 'Update failed');
        }
      }

      async function deleteMedicine(id) {
        try {
          const res = await fetch(`http://localhost:5000/api/medicines/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token }),
          });

          const json = await res.json();
          if (!res.ok) throw new Error(json.message || 'Could not delete');
          await loadMedicines();
        } catch (err) {
          console.error(err);
          alert(err.message || 'Delete failed');
        }
      }
    </script>
  </body>
</html>
